From b91fd8e27c814a9666913a94827e5e81c7312a3c Mon Sep 17 00:00:00 2001
From: Michael McAuliffe <michael.e.mcauliffe@gmail.com>
Date: Thu, 9 Feb 2023 15:53:35 -0800
Subject: [PATCH] CMakeLists

---
 CMakeLists.txt     | 37 +++++++++++++++++++++++++++++++++++++
 Makefile           |  2 +-
 src/CMakeLists.txt | 31 +++++++++++++++++++++++++++++++
 3 files changed, 69 insertions(+), 1 deletion(-)
 create mode 100644 CMakeLists.txt
 create mode 100644 src/CMakeLists.txt

diff --git CMakeLists.txt CMakeLists.txt
new file mode 100644
index 0000000..245ea87
--- /dev/null
+++ CMakeLists.txt
@@ -0,0 +1,37 @@
+
+cmake_minimum_required(VERSION 3.18)
+set(PROJECT_NAME vector)
+set(PROEJCT_VERSION "0.4.0")
+project(${PROJECT_NAME} VERSION ${PROEJCT_VERSION} LANGUAGES C)
+
+include(GNUInstallDirs)
+set(CMAKE_MACOSX_RPATH 1)
+
+find_package(PostgreSQL REQUIRED)
+
+
+set(CMAKE_POSITION_INDEPENDENT_CODE ON)
+find_package(PostgreSQL  REQUIRED)
+if (MSVC)
+
+    #set(CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS ON)
+    add_compile_options(/O2 /fp:fast)
+
+    else()
+    add_compile_options(-ftree-vectorize -fassociative-math -fno-signed-zeros -fno-trapping-math)
+endif (MSVC)
+
+
+add_subdirectory(src)
+
+set(EXT_CONTROL_FILE ${PROJECT_NAME}.control)
+configure_file(${EXT_CONTROL_FILE} ${EXT_CONTROL_FILE})
+install(
+        FILES ${CMAKE_CURRENT_BINARY_DIR}/${EXT_CONTROL_FILE}
+        DESTINATION ${CMAKE_PREFIX_PATH}/share/extension)
+INSTALL(
+    FILES ${CMAKE_SOURCE_DIR}/sql/${PROJECT_NAME}.sql 
+    DESTINATION ${CMAKE_PREFIX_PATH}/share/extension
+    RENAME ${PROJECT_NAME}--${PROEJCT_VERSION}.sql)
+
+INSTALL(DIRECTORY ${CMAKE_SOURCE_DIR}/sql/ DESTINATION ${CMAKE_PREFIX_PATH}/share/extension)
\ No newline at end of file
diff --git Makefile Makefile
index 3a350d4..a251905 100644
--- Makefile
+++ Makefile
@@ -37,7 +37,7 @@ sql/$(EXTENSION)--$(EXTVERSION).sql: sql/$(EXTENSION).sql
 EXTRA_CLEAN = sql/$(EXTENSION)--$(EXTVERSION).sql
 
 PG_CONFIG ?= pg_config
-PGXS := $(shell $(PG_CONFIG) --pgxs)
+PGXS ?= $(shell $(PG_CONFIG) --pgxs)
 include $(PGXS)
 
 # for Mac
diff --git src/CMakeLists.txt src/CMakeLists.txt
new file mode 100644
index 0000000..7456ab6
--- /dev/null
+++ src/CMakeLists.txt
@@ -0,0 +1,31 @@
+
+
+add_library(vector
+  MODULE
+  ivfbuild.c 
+  ivfflat.c 
+  ivfinsert.c 
+  ivfkmeans.c 
+  ivfscan.c 
+  ivfutils.c 
+  ivfvacuum.c 
+  vector.c
+)
+target_include_directories(vector PUBLIC $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}>
+                           $<INSTALL_INTERFACE:include>)
+target_include_directories(vector PRIVATE ${PostgreSQL_INCLUDE_DIRS})
+if (MSVC)
+target_include_directories(vector PRIVATE ${CMAKE_PREFIX_PATH}/include/server/port/win32)
+target_include_directories(vector PRIVATE ${CMAKE_PREFIX_PATH}/include/server/port/win32_msvc)
+target_link_libraries(vector ${PostgreSQL_LIBRARIES})
+
+endif(MSVC)
+
+set_target_properties(vector PROPERTIES PREFIX "")
+
+install(TARGETS vector
+LIBRARY DESTINATION lib
+ARCHIVE DESTINATION lib
+RUNTIME DESTINATION bin
+  )
+
-- 
2.38.1

